 AI销售助手系统设计文档 (LangGraph + DSPy多Agent架构版)

  1. 系统模块架构图

  AI销售助手系统 (LangGraph编排 + DSPy Agent + LlamaIndex RAG + TextGrad优化)
  ├── 接入层 (API Gateway)
  │   ├── FastAPI + WebSocket API
  │   ├── 多渠道适配器 (微信/官网/APP)
  │   └── 认证鉴权模块
  │
  ├── 安全合规层 (Security & Compliance)
  │   ├── Presidio PII脱敏
  │   ├── Guardrails 输出校验
  │   └── Instructor 结构化验证
  │
  ├── LLM统一网关层 (LLM Gateway)
  │   └── LiteLLM (多模型统一接口 + 成本优化)
  │
  ├── Agent编排层 (LangGraph Orchestration)
  │   ├── 销售状态图编排 (LangGraph StateGraph)
  │   │   ├── 状态节点: 需求发现 → 课程推荐 → 异议处理 → 促单成交
  │   │   ├── 边条件: 销售阶段转换逻辑
  │   │   └── 并行执行: Agent并行处理 + 结果聚合
  │   │
  │   ├── DSPy Agent模块 (每个Agent都是dspy.Module)
  │   │   ├── 对话管理Agent (ConversationManager dspy.Module)
  │   │   │   ├── 会话状态管理
  │   │   │   ├── LLM意图识别 
  │   │   │   ├── 实时用户画像更新
  │   │   │   └── 销售阶段路由
  │   │   │
  │   │   ├── 需求发现Agent (NeedDiscovery dspy.Module)
  │   │   │   ├── 深度需求理解
  │   │   │   ├── 用户痛点识别
  │   │   │   └── 需求挖掘话术生成
  │   │   │
  │   │   ├── 课程推荐Agent (CourseRecommendation dspy.Module)
  │   │   │   ├── LLM个性化推荐
  │   │   │   ├── 推荐理由生成
  │   │   │   └── 推荐展示话术生成
  │   │   │
  │   │   ├── 异议处理Agent (ObjectionHandling dspy.Module)
  │   │   │   ├── 异议类型识别
  │   │   │   ├── 针对性回应策略
  │   │   │   └── 异议处理话术生成
  │   │   │
  │   │   └── 促单成交Agent (ConversionClosing dspy.Module)
  │   │       ├── 价格敏感度分析
  │   │       ├── 个性化优惠方案生成
  │   │       └── 促单成交话术生成
  │   │
  │   └── Celery异步任务编排
  │       ├── Agent协作工作流
  │       ├── 长时间任务处理
  │       └── 错误重试机制
  │
  ├── RAG知识服务层 (LlamaIndex RAG)
  │   ├── LlamaIndex数据连接器
  │   │   ├── 课程文档加载器
  │   │   ├── 用户评价连接器
  │   │   └── FAQ数据源
  │   │
  │   ├── 智能索引构建
  │   │   ├── 文档智能切块
  │   │   ├── 向量索引 (Qdrant)
  │   │   ├── 关键词索引
  │   │   └── 混合索引
  │   │
  │   ├── 检索优化
  │   │   ├── 向量检索 (召回)
  │   │   ├── Cohere Rerank (精排)
  │   │   └── 语义相关性优化
  │   │
  │   └── LlamaIndex Chat Engine
  │       ├── 对话式检索
  │       ├── 多轮上下文
  │       └── 知识问答
  │
  ├── 自优化模块 (TextGrad) - 最后开发
  │   ├── TextGrad话术优化
  │   │   ├── 话术效果评估
  │   │   ├── 梯度反传优化
  │   │   └── A/B测试框架
  │   │
  │   ├── DSPy模块优化
  │   │   ├── Agent参数调优
  │   │   ├── Prompt自动优化
  │   │   └── 性能基准测试
  │   │
  │   └── 持续学习机制
  │       ├── 用户反馈收集
  │       ├── 转化效果分析
  │       └── 模型迭代更新
  │
  ├── 能力服务层 (Capability Services)
  │   ├── 数据能力服务
  │   │   ├── PostgreSQL查询服务
  │   │   ├── 用户画像服务 (Redis)
  │   │   └── 行为统计分析
  │   │
  │   ├── 优惠策略服务
  │   │   ├── 价格策略计算
  │   │   ├── 优惠规则引擎
  │   │   └── 库存管理
  │   │
  │   └── 系统服务
  │       ├── Redis会话管理
  │       ├── Celery任务队列
  │       └── 通知推送
  │
  ├── 评测监控层 (Observability & Evaluation)
  │   ├── LangSmith链路追踪
  │   │   ├── Agent决策监控
  │   │   ├── 响应时间分析
  │   │   └── 用户交互追踪
  │   │
  │   ├── LlamaIndex Eval评测
  │   │   ├── 检索质量评估
  │   │   ├── 生成效果评测
  │   │   └── RAG端到端评估
  │   │
  │   └── DSPy评估框架
  │       ├── Agent模块性能评估
  │       ├── 结构化输出质量
  │       └── 优化效果监控
  │
  └── 基础设施层 (Infrastructure)
      ├── PostgreSQL (业务数据)
      ├── Qdrant (向量数据库)
      ├── Redis Cluster (缓存/任务队列)
      ├── Docker + Kubernetes (容器编排)
      └── Helm + Istio (部署 + 服务网格)

● 2. 各模块职责说明

  2.1 接入层模块

  - API Gateway: 统一接口管理，负载均衡，请求路由和限流
  - 多渠道适配器: 适配不同平台的消息格式和协议（微信API、WebSocket等）
  - 认证鉴权模块: 用户身份验证，权限控制，API密钥管理

  2.2 Agent协调层模块 (销售状态驱动)

  - 对话管理Agent: 核心控制中枢，负责会话管理、LLM意图识别、实时用户画像更新、销售阶段判断和Agent路由分发
  - 需求发现Agent: 专注需求挖掘阶段，通过深度提问明确用户学习目标和痛点，生成需求挖掘话术
  - 课程推荐Agent: 专注推荐匹配阶段，使用LLM进行个性化课程推荐，生成推荐理由和展示话术
  - 异议处理Agent: 专注异议消除阶段，识别异议类型并制定针对性回应策略，生成异议处理话术
  - 促单成交Agent: 专注成交促进阶段，分析用户价格心理，生成个性化优惠方案和成交话术

  2.3 标准化Workflow层

  - 销售流程Workflow: 定义标准化的销售流程，确保按需求发现→课程推荐→异议处理→促单成交的顺序进行，根据销售阶段自动路由到对应Agent

  2.4 自优化模块 (TextGrad)

  - Agent效果评估: 监测各Agent的决策准确率和话术转化效果
  - 推荐质量监测: 分析课程推荐的点击率、转化率和用户满意度
  - 优惠策略效果分析: 评估不同优惠方案的成交率和利润率
  - Workflow流程优化: 识别销售流程瓶颈并优化路径
  - 持续学习机制: 基于用户反馈自动调优Agent参数

  2.5 能力层模块

  - 数据能力服务: 提供结构化数据查询、实时用户画像更新、行为统计分析和转化预测
  - 搜索检索服务: 提供RAG检索、课程知识库查询、用户评价检索和FAQ检索
  - 优惠策略服务: 支持促单成交Agent的价格策略计算、优惠规则管理、用户权益计算和库存统计
  - 系统能力服务: 提供会话管理、消息队列、缓存和通知推送等基础服务

  3. 技术选型理由

  3.1 多Agent编排框架

  - LangGraph: 主要编排框架，专为多Agent系统设计，支持复杂的Agent协作流程和状态管理
  - 状态图编排: 将销售流程建模为状态图，Agent间转换清晰可控
  - 并行执行支持: 支持Agent并行处理和结果聚合，提升响应速度

  3.2 Agent内部逻辑框架

  - DSPy: 每个Agent都作为dspy.Module实现，便于优化和评测
  - 模块化设计: 对话管理Agent、需求发现Agent、课程推荐Agent、异议处理Agent、促单成交Agent都是独立的dspy.Module
  - 自动优化: 支持基于评测数据的自动prompt优化和参数调优
  - 结构化输出: 内置对结构化输出的支持，确保Agent响应格式一致性
  - TextGrad集成: 与TextGrad框架深度集成，支持基于梯度的Agent优化

  3.3 自优化框架

  - TextGrad: 专门用于文本优化和梯度反传，支持话术效果的自动优化和Agent参数调优
  - 话术优化: 基于转化率反馈进行话术梯度优化
  - DSPy协同: 与DSPy模块协同工作，实现端到端的Agent优化
  - A/B测试: 内置A/B测试框架，支持话术变体效果对比

  3.4 RAG检索框架

  - LlamaIndex: 完整的RAG解决方案，从数据连接到查询生成的全流程支持
  - 数据连接器: 支持多种数据源（文档、API、数据库）的统一接入
  - 智能切块: 自动文档分割和语义边界识别
  - 索引构建: 支持向量索引、关键词索引和混合索引
  - Chat Engine: 提供对话式检索能力，支持多轮对话上下文

  3.5 检索优化

  - Cohere Rerank: 专业的检索结果重排序服务，提升检索相关性
  - 二阶段检索: 第一阶段用向量检索召回候选，第二阶段用Cohere精确排序
  - 语义相关性优化: 基于深度学习的语义匹配，提升推荐准确度

  3.6 LLM统一网关

  - LiteLLM: 轻量级LLM代理，支持多种LLM提供商的统一接口
  - 自托管方案: 轻量级部署，降低外部依赖
  - 成本优化: 支持多模型负载均衡和成本控制
  - 统一接口: 为所有Agent提供一致的LLM调用接口

  3.7 异步任务处理

  - Celery: 分布式任务队列，支持Agent间异步协作和长时间任务处理
  - Redis Backend: 高性能任务存储和结果缓存
  - 任务编排: 支持复杂的Agent协作工作流
  - 错误处理: 完善的任务重试和异常处理机制

  3.8 评测与可观测性

  - LangSmith: 完整的LLM应用监控平台，提供链路追踪和性能分析
  - LlamaIndex Eval: 专业的RAG评测框架，评估检索质量和生成效果
  - DSPy评估: Agent模块性能评估和结构化输出质量监控
  - Agent性能监控: 每个Agent的决策准确率、响应时间、转化效果监控

  3.9 安全合规

  - Presidio: 微软开源的PII识别和脱敏框架，保护用户隐私数据
  - Guardrails: 结构化输出校验框架，确保Agent输出的安全性和合规性
  - Instructor: 结构化输出验证，确保Agent响应格式和内容的正确性
  - 数据脱敏: 自动识别和处理敏感信息（手机号、身份证等）

  3.10 数据存储

  - PostgreSQL: 主业务数据库，支持ACID事务，存储用户信息、对话记录、课程数据
  - Qdrant: 向量数据库，与LlamaIndex深度集成，提供高性能语义检索
  - Redis Cluster: 分布式缓存，存储会话状态、用户画像和Celery任务队列
  - 数据安全: 静态数据加密，传输层TLS加密

  3.11 容器编排和部署

  - Docker + Kubernetes: 容器编排，支持Agent服务的独立部署和弹性扩缩容
  - Helm Charts: 应用包管理，简化部署和版本管理
  - Service Mesh: Istio提供Agent间通信的安全和监控

● 4. 完整数据流架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            AI销售助手系统完整架构                                      │
│                    (LangGraph + DSPy + LlamaIndex + TextGrad)                       │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户接入层      │    │   安全合规层      │    │   LLM统一网关    │
│                 │    │                 │    │                 │
│ • FastAPI       │ ─> │ • Presidio      │ ─> │ • LiteLLM       │
│ • WebSocket     │    │ • Guardrails    │    │ • 多模型支持      │
│ • 多渠道适配      │    │ • Instructor    │    │ • 成本优化       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         v                       v                       v
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         Agent编排层 (LangGraph)                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    销售状态图编排 (StateGraph)                             │   │
│  │                                                                           │   │
│  │  需求发现 → 课程推荐 → 异议处理 → 促单成交                                  │   │
│  │     ↓         ↓         ↓         ↓                                      │   │
│  │  状态转换条件 + Agent并行执行 + 结果聚合                                   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                   DSPy Agent模块层 (每个Agent = dspy.Module)              │   │
│  │                                                                           │   │
│  │ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────┐  │
│  │ │对话管理Agent │ │需求发现Agent │ │课程推荐Agent │ │异议处理Agent │ │促单成交│  │
│  │ │              │ │              │ │              │ │              │ │Agent   │  │
│  │ │• 会话状态管理│ │• 深度需求理解│ │• LLM个性化推│ │• 异议类型识别│ │• 价格敏│  │
│  │ │• LLM意图识别│ │• 痛点识别分析│ │• 推荐理由生成│ │• 针对性回应  │ │  感度分│  │
│  │ │• 用户画像更新│ │• 需求挖掘话术│ │• 展示话术生成│ │• 信任建立机制│ │  析    │  │
│  │ │• 销售阶段路由│ │• 学习动机分析│ │• 匹配度计算  │ │• 异议处理话术│ │• 优惠方│  │
│  │ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ │  案生成│  │
│  │                                                                     │• 成交话│  │
│  │                                                                     │  术生成│  │
│  │                                                                     └────────┘  │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                   Celery异步任务编排 (Redis作为broker)                      │   │
│  │                                                                           │   │
│  │ • Redis消息队列 → Celery Worker → Agent协作工作流                          │   │
│  │ • 长时间任务处理 • 错误重试机制 • 任务监控                                   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
         │                                           │                         │
         │                                           │                         │
         v                                           v                         v
┌─────────────────┐    ┌─────────────────────────────────────────┐    ┌─────────────────┐
│  RAG知识服务层   │    │            能力服务层                    │    │ TextGrad自优化  │
│  (LlamaIndex)   │    │        (工具性服务支持)                  │    │   (最后开发)     │
│                 │    │                                       │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ ┌─────────────────┐   │    │ ┌─────────────┐ │
│ │数据连接器    │ │    │ │数据能力服务  │ │ 优惠策略服务      │   │    │ │话术效果评估  │ │
│ │• 课程文档    │ │    │ │• 数据库查询  │ │ • 价格策略计算    │   │    │ │• TextGrad   │ │
│ │• 用户评价    │ │    │ │• 用户画像    │ │ • 优惠规则管理    │   │    │ │  框架集成    │ │
│ │• FAQ数据    │ │    │ │• 行为统计    │ │ • 用户权益计算    │   │    │ │• A/B测试    │ │
│ └─────────────┘ │    │ │• 转化预测    │ │ • 库存稀缺统计    │   │    │ │• 梯度优化    │ │
│                 │    │ └─────────────┘ └─────────────────┘   │    │ └─────────────┘ │
│ ┌─────────────┐ │    │                                       │    │                 │
│ │智能索引构建  │ │    │ ┌─────────────┐ ┌─────────────────┐   │    │ ┌─────────────┐ │
│ │• 文档切块    │ │ <──┤ │搜索检索服务  │ │ 系统能力服务      │   │    │ │DSPy模块优化 │ │
│ │• 向量索引    │ │    │ │• RAG检索    │ │ • Redis会话管理   │   │    │ │• Agent参数  │ │
│ │• 混合索引    │ │    │ │• 课程知识库  │ │ • Celery任务队列  │   │    │ │  自动调优    │ │
│ └─────────────┘ │    │ │• 用户评价    │ │ • 缓存服务       │   │    │ │• Prompt优化 │ │
│                 │    │ │• FAQ检索    │ │ • 通知推送       │   │    │ │• 性能基准    │ │
│ ┌─────────────┐ │    │ └─────────────┘ └─────────────────┘   │    │ └─────────────┘ │
│ │检索优化      │ │    └─────────────────────────────────────────┘    │                 │
│ │• 向量检索    │ │                        │                         │ ┌─────────────┐ │
│ │• Cohere     │ │                        │                         │ │持续学习机制  │ │
│ │  Rerank     │ │                        │                         │ │• 用户反馈    │ │
│ │• Chat Engine│ │                        │                         │ │• 转化效果    │ │
│ └─────────────┘ │                        │                         │ │• 模型迭代    │ │
└─────────────────┘                        │                         │ └─────────────┘ │
         │                                 │                         └─────────────────┘
         │                                 │                                   │
         v                                 v                                   v
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          评测监控层 (Observability & Evaluation)                    │
│                                                                                     │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────────────────┐   │
│ │ LangSmith       │ │ LlamaIndex Eval │ │ DSPy评估框架                        │   │
│ │ 链路追踪         │ │ RAG评测         │ │ Agent性能监控                       │   │
│ │                 │ │                 │ │                                     │   │
│ │ • Agent决策监控  │ │ • 检索质量评估   │ │ • 模块性能评估                       │   │
│ │ • 响应时间分析   │ │ • 生成效果评测   │ │ • 结构化输出质量                     │   │
│ │ • 用户交互追踪   │ │ • 端到端评估     │ │ • 优化效果监控                       │   │
│ └─────────────────┘ └─────────────────┘ └─────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        v
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              基础设施层 (Infrastructure)                            │
│                                                                                     │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────────┐   │
│ │ PostgreSQL  │ │ Qdrant      │ │ Redis       │ │ Docker + Kubernetes         │   │
│ │ 业务数据     │ │ 向量数据库   │ │ 缓存/队列    │ │ 容器编排                     │   │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

● 5. 组件依赖关系说明

  4.1 核心依赖链路 (销售状态驱动)

  接入层 → 对话管理Agent → 销售状态判断 → 对应专业Agent → 能力层服务 → LLM服务
          ↓               ↓               ↓               ↓
      会话缓存          用户画像更新        Agent决策         自优化模块

  4.2 Agent依赖关系

  - 对话管理Agent: 依赖LLM服务进行意图识别，依赖Redis维护会话状态，依赖用户画像服务实时更新用户特征
  - 需求发现Agent: 依赖对话管理Agent提供的用户画像和上下文，依赖LLM服务生成需求挖掘话术
  - 课程推荐Agent: 依赖RAG检索服务获取课程知识，依赖数据库服务查询课程信息，依赖LLM服务进行个性化推荐
  - 异议处理Agent: 依赖课程知识库和FAQ检索服务，依赖用户行为分析服务了解用户特征，依赖LLM服务生成回应话术
  - 促单成交Agent: 依赖优惠策略服务计算价格方案，依赖用户画像分析支付能力，依赖LLM服务生成成交话术

  4.3 能力层依赖

  - 数据能力服务: 依赖PostgreSQL进行结构化查询，依赖Redis缓存用户画像，依赖Celery处理异步数据更新
  - 搜索检索服务: 依赖Qdrant向量数据库进行语义检索，依赖PostgreSQL查询结构化课程数据
  - 优惠策略服务: 依赖数据库服务获取定价信息，依赖用户行为服务分析购买模式，依赖业务规则引擎计算优惠
  - 系统能力服务: 依赖Redis管理会话状态，依赖Celery处理Agent间异步任务传递

  4.4 数据流依赖

  - 实时数据流: 用户输入 → 对话管理Agent → 用户画像更新 → 专业Agent决策 → 话术生成 → 用户响应
  - 异步数据流: Agent决策数据 → 行为统计服务 → TextGrad优化模块 → Agent参数更新 → 性能提升
  - 缓存数据流: 热点课程信息 → Redis缓存 → Agent快速访问 → 响应时间优化

  5. 数据流示意

  5.1 用户输入到响应生成流程 (销售状态驱动)

  1. 用户消息输入
     ↓
  2. API Gateway接收并路由
     ↓
  3. 对话管理Agent处理
     ├── LLM意图识别 → 识别用户意图和销售阶段
     ├── 用户画像更新 → 实时更新用户特征
     └── 销售状态路由 → 决定调用哪个专业Agent
     ↓
  4. 专业Agent处理（根据销售状态）
     ├── 需求发现Agent → 深度挖掘需求 + 生成挖掘话术
     ├── 课程推荐Agent → LLM个性化推荐 + 生成展示话术
     ├── 异议处理Agent → 异议识别分析 + 生成回应话术
     └── 促单成交Agent → 优惠方案生成 + 生成成交话术
     ↓
  5. 能力层服务支持
     ├── RAG检索服务 → 提供相关课程知识
     ├── 数据库服务 → 查询课程和用户信息
     ├── 优惠策略服务 → 计算个性化优惠方案
     └── 用户行为服务 → 分析用户行为模式
     ↓
  6. LLM服务处理
     ├── Prompt工程 → 优化Agent输入格式
     ├── 模型推理 → 生成Agent决策和话术
     └── 后处理 → 格式化输出结果
     ↓
  7. 响应回传给用户
     ↓
  8. 自优化模块收集数据 (异步)
     ├── Agent决策效果跟踪 → 评估决策准确性
     ├── 话术转化率分析 → 监测话术效果
     └── 持续优化反馈 → 调整Agent参数

  5.2 Agent间协作数据流

  对话管理Agent → (用户画像+上下文) → 专业Agent → (决策结果+话术) → 用户响应 → (效果数据) → TextGrad优化

  5.3 关键数据实体

  - 用户会话: session_id, user_id, sales_stage, context, user_profile, created_at
  - Agent决策: agent_type, decision_result, confidence, reasoning, timestamp
  - 课程推荐: course_ids, recommendation_reasons, matching_scores, personalization_factors
  - 优惠方案: discount_type, discount_amount, validity_period, target_user_profile
  - 效果数据: conversion_rate, user_satisfaction, agent_accuracy, response_time

● 6. 开发实施建议

  6.1 开发阶段划分

  1. Phase 1: 核心Agent开发 (对话管理 + 需求发现 + 课程推荐)
  2. Phase 2: 销售闭环完善 (异议处理 + 促单成交 + 优惠策略)
  3. Phase 3: 自优化集成 (TextGrad模块 + 效果监测 + 持续改进)

  6.2 关键技术风险

  - Agent协作复杂度: 通过标准化Workflow和清晰的状态管理降低复杂度
  - LLM推理延迟: 考虑模型量化、缓存策略和Agent并行处理
  - 个性化推荐准确性: 建立完善的用户画像体系和反馈机制
  - 优惠策略风控: 设置合理的优惠上限和风控规则

  6.3 可扩展性设计

  - Agent独立部署: 每个Agent可独立扩展和更新，支持灵活的资源配置
  - 销售状态扩展: 支持新增销售阶段和对应的专业Agent
  - 业务场景扩展: 架构支持后续扩展到其他垂直业务场景（留学中介、论文代写等）
  - 优化算法升级: TextGrad模块支持不同优化算法的插件化集成

  该系统设计以销售状态驱动的Agent协作为核心，既保证了专业化分工，又实现了高效协作和持续优化。