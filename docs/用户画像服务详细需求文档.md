# 用户画像服务详细需求文档

## 1. 需求概述

基于成本优化的多Agent架构，实现集成在对话管理Agent中的用户画像服务。采用一问一答模式，通过单次LLM调用完成用户画像增量更新，为专业Agent提供实时的用户特征数据支持。

## 2. 核心设计原则

### 2.1 成本优化原则
- **多任务集成**：对话管理Agent单次LLM调用完成多任务
- **增量更新**：只更新变化的用户特征字段
- **智能缓存**：热点用户画像Redis缓存优化
- **模板优先**：简单场景避免不必要的LLM调用

### 2.2 一问一答模式适配
- **会话状态管理**：严格的用户状态控制（IDLE/WAITING/PROCESSING）
- **单轮优化**：专注提升单轮对话的画像更新质量
- **上下文累积**：基于完整对话历史的画像构建

## 3. 用户画像数据模型

### 3.1 核心数据结构

```python
class UserProfile(BaseModel):
    # 基础信息
    user_id: str
    session_id: str
    channel_source: str  # 渠道来源
    created_at: datetime
    updated_at: datetime
    
    # 学习需求维度
    learning_goals: Optional[List[str]] = []  # 学习目标
    pain_points: Optional[List[str]] = []     # 痛点问题
    motivation_type: Optional[str] = None      # 学习动机类型
    urgency_level: Optional[int] = None        # 紧急程度 1-5
    
    # 预算时间维度
    budget_range: Optional[str] = None         # 预算范围
    time_availability: Optional[str] = None    # 时间可用性
    learning_duration: Optional[str] = None    # 期望学习周期
    
    # 技能背景维度
    current_skill_level: Optional[str] = None  # 当前技能水平
    related_experience: Optional[List[str]] = [] # 相关经验
    learning_ability: Optional[str] = None     # 学习能力评估
    
    # 行为特征维度
    communication_style: Optional[str] = None  # 沟通风格
    decision_pattern: Optional[str] = None     # 决策模式
    response_speed: Optional[str] = None       # 响应速度特征
    
    # 价格敏感度维度
    price_sensitivity: Optional[str] = None    # 价格敏感度
    payment_preference: Optional[str] = None   # 支付偏好
    discount_response: Optional[str] = None    # 优惠反应
    
    # 置信度和元信息
    field_confidence: Dict[str, float] = {}    # 各字段置信度
    update_count: int = 0                      # 更新次数
    data_completeness: float = 0.0             # 数据完整度
```

### 3.2 字段验证规则

```python
class ProfileValidationRules:
    URGENCY_LEVELS = [1, 2, 3, 4, 5]
    SKILL_LEVELS = ["beginner", "intermediate", "advanced", "expert"]
    BUDGET_RANGES = ["<1000", "1000-5000", "5000-10000", "10000+"]
    PRICE_SENSITIVITY = ["high", "medium", "low"]
    # ... 更多验证规则
```

## 4. 架构设计

### 4.1 对话管理Agent集成架构

```
用户输入 → 对话管理Agent
            ↓ (单次LLM调用)
    ┌─────────────────────────────────┐
    │ 多任务处理 (Comprehensive LLM)  │
    │ - 上下文分析                     │
    │ - 意图识别                      │  
    │ - 阶段判断                      │
    │ - 用户画像增量提取               │
    │ - 路由决策                      │
    └─────────────────────────────────┘
            ↓
    用户画像服务 (数据处理和存储)
            ↓
    专业Agent (基于最新画像)
```

### 4.2 数据流设计

```
对话历史 + 当前输入
    ↓
Comprehensive Prompt
    ↓
LLM结构化输出 {
    intent: {...},
    stage: {...},
    profile_updates: {...},
    routing: {...}
}
    ↓
用户画像增量更新
    ↓
Redis缓存更新 + PostgreSQL持久化
```

## 5. 核心功能需求

### 5.1 用户画像CRUD服务

**5.1.1 创建用户画像**
- 初始化空白画像模型
- 设置默认值和初始置信度
- 创建Redis缓存和数据库记录

**5.1.2 查询用户画像**
- Redis缓存优先查询
- 缓存未命中时查询数据库
- 返回完整画像数据和置信度信息

**5.1.3 增量更新用户画像**
- 基于LLM提取的新信息更新画像
- 置信度加权合并算法
- 数据验证和一致性检查

**5.1.4 画像数据管理**
- 批量更新支持
- 历史版本管理
- 数据导出和统计

### 5.2 对话管理Agent集成

**5.2.1 多任务Prompt设计**
```python
COMPREHENSIVE_PROMPT = """
基于以下对话历史和当前用户输入，请完成以下任务并返回JSON格式结果：

1. 上下文分析：分析对话历史，提取关键状态信息
2. 意图识别：识别用户当前意图和需求变化
3. 销售阶段判断：基于对话内容判断当前销售阶段
4. 用户画像更新：提取新的用户特征信息
5. Agent路由：选择最适合的专业Agent

对话历史：{conversation_history}
当前输入：{user_input}
现有用户画像：{current_profile}

请返回结构化JSON：
{
    "context_analysis": {...},
    "intent_recognition": {...},
    "stage_judgment": {...},
    "profile_updates": {...},
    "agent_routing": {...}
}
"""
```

**5.2.2 结构化输出解析**
- Pydantic模型验证LLM输出
- 异常处理和数据修正
- 置信度评分计算

### 5.3 数据质量保证

**5.3.1 字段验证**
- 数据类型验证
- 取值范围检查
- 必填字段验证
- 格式规范检查

**5.3.2 逻辑一致性检查**
- 跨字段逻辑验证（如预算与课程价格匹配）
- 时间逻辑一致性（如紧急程度与时间安排）
- 技能水平与需求目标一致性

**5.3.3 异常数据处理**
- 异常值检测算法
- 自动修正策略
- 人工审核工作流
- 数据质量评分

### 5.4 性能优化

**5.4.1 缓存策略**
- Redis热点用户画像缓存
- 多级缓存架构
- 缓存失效策略
- 缓存命中率监控

**5.4.2 数据库优化**
- 索引优化策略
- 查询性能优化
- 批量操作支持
- 连接池管理

## 6. 技术实现要求

### 6.1 技术栈
- **后端框架**：FastAPI
- **数据验证**：Pydantic v2
- **数据库**：PostgreSQL + SQLAlchemy
- **缓存**：Redis
- **LLM集成**：LiteLLM
- **数据处理**：Pandas

### 6.2 性能指标
- **响应时间**：用户画像查询 < 50ms
- **更新延迟**：画像更新完成 < 200ms
- **缓存命中率**：> 85%
- **数据准确率**：字段提取准确率 > 80%
- **完整性**：画像数据完整度 > 70%

### 6.3 可靠性要求
- **数据一致性**：Redis与PostgreSQL数据一致
- **故障容错**：单点故障不影响服务
- **数据恢复**：支持画像数据备份和恢复
- **监控告警**：关键指标实时监控

## 7. 业务集成需求

### 7.1 专业Agent集成
- **需求发现Agent**：提供学习需求和动机数据
- **课程推荐Agent**：提供技能水平和偏好数据
- **异议处理Agent**：提供决策模式和顾虑信息
- **促单成交Agent**：提供价格敏感度和支付能力数据

### 7.2 数据分析支持
- **用户画像统计**：用户特征分布分析
- **转化率分析**：画像完整度与转化率关系
- **A/B测试支持**：不同画像策略效果对比
- **业务洞察**：用户行为模式分析

## 8. 安全和隐私要求

### 8.1 数据隐私保护
- **敏感数据加密**：个人信息字段加密存储
- **访问权限控制**：基于角色的数据访问
- **数据脱敏**：日志和监控数据脱敏
- **合规要求**：符合数据保护法规

### 8.2 安全防护
- **输入验证**：防止SQL注入和XSS攻击
- **API安全**：接口权限验证和限流
- **数据传输**：HTTPS加密传输
- **审计日志**：用户画像操作审计

## 9. 监控和运维

### 9.1 监控指标
- **业务指标**：画像更新成功率、数据完整度、查询响应时间
- **技术指标**：缓存命中率、数据库连接数、内存使用率
- **质量指标**：数据准确率、一致性检查通过率

### 9.2 日志管理
- **操作日志**：用户画像CRUD操作记录
- **错误日志**：异常和错误详细信息
- **性能日志**：响应时间和性能指标
- **审计日志**：敏感操作审计记录

## 10. 验收标准

### 10.1 功能验收
- [ ] 用户画像CRUD功能完整实现
- [ ] 对话管理Agent成功集成画像更新
- [ ] 数据验证和质量保证机制运行正常
- [ ] 专业Agent能正确获取和使用画像数据

### 10.2 性能验收
- [ ] 画像查询响应时间 < 50ms
- [ ] 画像更新完成时间 < 200ms
- [ ] 缓存命中率 > 85%
- [ ] 并发处理能力 > 500用户

### 10.3 质量验收
- [ ] 字段提取准确率 > 80%
- [ ] 数据一致性检查通过率 > 95%
- [ ] 画像数据完整度 > 70%
- [ ] 异常数据自动修正率 > 60%

### 10.4 业务验收
- [ ] 专业Agent基于画像的推荐准确率提升 > 20%
- [ ] 促单成交Agent价格敏感度分析准确率 > 80%
- [ ] 用户画像驱动的个性化效果满意度 > 4.0/5.0